---
name: Sync tags
on:
  push:
    tags:
      - v?[0-9]+.[0-9]+.[0-9]+
jobs:
  update-tags:
    name: v{major} and v{major}.{minor}
    runs-on: ubuntu-24.04
    steps:
      - name: Generate app token
        id: app-token
        uses: actions/create-github-app-token@c1a285145b9d317df6ced56c09f525b5c2b6f755 # v1.11.1
        with:
          app-id: ${{ vars.CICD_APP_ID }}
          private-key: ${{ secrets.CICD_PRIVATE_KEY }}
      - name: Check out repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ steps.app-token.outputs.token }}
      - name: Fetch app UID
        id: app-uid
        shell: bash
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          app_name: ${{ steps.app-token.outputs.app-slug }}[bot]
        run: |
          cat >>"$GITHUB_OUTPUT" <<EOF
          string=$(gh api "/users/$app_name" --jq .id)
          EOF
      - name: Tag major and minor versions
        shell: bash
        env:
          GIT_AUTHOR_NAME: ${{ steps.app-token.outputs.app-slug }}[bot]
          GIT_AUTHOR_EMAIL: ${{ steps.app-uid.outputs.string }}+${{ steps.app-token.outputs.app-slug }}[bot]@noreply.users.github.com
          GIT_COMMITTER_NAME: ${{ steps.app-token.outputs.app-slug }}[bot]
          GIT_COMMITTER_EMAIL: ${{ steps.app-uid.outputs.string }}+${{ steps.app-token.outputs.app-slug }}[bot]@noreply.users.github.com
        run: |
          git tag --force --annotate "${GITHUB_REF_NAME%.*}" --message "Release ${GITHUB_REF_NAME%.*} → $GITHUB_REF_NAME"
          git tag --force --annotate "${GITHUB_REF_NAME%%.*}" --message "Release ${GITHUB_REF_NAME%%.*} → $GITHUB_REF_NAME"
          git push --force --tags
