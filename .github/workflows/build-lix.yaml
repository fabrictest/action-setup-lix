---
name: Build / Lix
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
  push:
    branches:
      - main
  schedule:
    - cron: 33 01 * * *
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  build-lix-stores:
    name: Build Lix stores
    strategy:
      fail-fast: true
      matrix:
        runs-on:
          - macos-13 # X64
          - macos-15 # ARM64
          - ubuntu-24.04
    runs-on: ${{ matrix.runs-on }}
    permissions:
      attestations: write
      id-token: write
    steps:
      - name: Bootstrap Lix
        uses: fabrictest/action-setup-lix@a745987f4ef56ddcc1df9d7974cef54f0704ca46 # v0.3.0
        with:
          lix-on-tmpfs: true
      - name: Set up Magic Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@6221693898146dc97e38ad0e013488a16477a4c4 # v9
        with:
          diagnostic-endpoint: ""
          use-flakehub: false
      - name: Check out repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - name: Build Lix stores
        run: |
          nix build .#lix-stores
        shell: bash
      - name: Attest Lix stores
        uses: actions/attest-build-provenance@520d128f165991a6c774bcb264f323e3d70747f4 # v2.2.0
        with:
          subject-path: result/lix-*.tar.*
      - name: Upload Lix stores to GitHub
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: lix-stores-${{ runner.os }}-${{ runner.arch }}
          path: result/lix-*.tar.*
      - name: Gather which Lix versions were built for this platform
        run: |
          printf %s\\n result/lix-*.tar.* |
            cut -d- -f2 |
            jq --compact-output --raw-input --arg runs-on "$runs_on" \
              '{"lix-version": .} + $ARGS.named' >build-matrix-"$runs_on".ndjson
        shell: bash
        env:
          runs_on: ${{ matrix.runs-on }}
      - name: Upload build matrix files to GitHub
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: build-matrix-${{ matrix.runs-on }}
          path: build-matrix-${{ matrix.runs-on }}.ndjson
          compression-level: 9
          retention-days: 1
  build-matrix:
    name: Resolve build matrix
    needs:
      - build-lix-stores
    runs-on: ubuntu-latest
    outputs:
      json: ${{ steps.matrix.outputs.json }}
    steps:
      - name: Download build matrix files
        id: files
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          pattern: build-matrix-*
          merge-multiple: true
      - name: Generate build matrix
        id: matrix
        run: |
          tee -a "$GITHUB_OUTPUT" <<EOF
          json<<JSON
          $(cat *.ndjson | jq --slurp '{build: .}')
          JSON
          EOF
        shell: bash
        working-directory: ${{ steps.files.outputs.download-path }}
  test-examples:
    name: Test examples
    needs:
      - build-matrix
    strategy:
      fail-fast: true
      matrix: ${{ fromjson(needs.build-matrix.outputs.json) }}
    runs-on: ${{ matrix.build.runs-on }}
    steps:
      - name: Check out repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - name: Download Lix store from GitHub
        id: lix-stores
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: lix-stores-${{ runner.os }}-${{ runner.arch }}
      - name: Install Lix ${{ matrix.build.lix-version }}
        uses: ./
        with:
          lix-on-tmpfs: true
          lix-store-dir: ${{ steps.lix-stores.outputs.download-path }}
          lix-version: ${{ matrix.build.lix-version }}
      - name: Verify that Lix was installed
        run: |
          nix-build -v --version
        shell: bash
      - name: Set up Cachix
        uses: cachix/cachix-action@ad2ddac53f961de1989924296a1f236fcfbaa4fc # v15
        with:
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          name: ${{ vars.CACHIX_NAME }}
      - name: Build flake
        run: |
          nix build ./examples/flakes
        shell: bash
      - name: Print `hello, world` message
        run: |
          ./result/bin/hello
        shell: bash
